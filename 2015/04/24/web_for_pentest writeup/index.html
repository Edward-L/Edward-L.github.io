<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>







<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.2"/>




  <meta name="keywords" content="Code_Injection,Command_Injection,Directory_traversal,File_Upload,LDAP_Attacks,PentesterLab,XML_Attacks,XSS,sql_injection," />



  <link rel="alternate" href="/atom.xml" title="Edward_L's Blog" type="application/atom+xml" />



  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.2" />




  <title> web_for_pentest writeup // Edward_L's Blog </title>
</head>

<body>
<!--[if lte IE 8]> <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'> <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode"><img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari." style='margin-left:auto;margin-right:auto;display: block;'/></a></div> <![endif]-->
  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <div id="header" class="header">
      <div class="header-inner">
        <h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand">
      <span class="logo">
        <i class="icon-logo"></i>
      </span>
      <span class="site-title">Edward_L's Blog</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>


  <ul id="menu" class="menu">
    
    
      
      <li class="menu-item menu-item-home">
        <a href="/">
          <i class="menu-item-icon icon-home"></i> <br />
          Home
        </a>
      </li>
    
      
      <li class="menu-item menu-item-categories">
        <a href="/categories">
          <i class="menu-item-icon icon-categories"></i> <br />
          Categories
        </a>
      </li>
    
      
      <li class="menu-item menu-item-archives">
        <a href="/archives">
          <i class="menu-item-icon icon-archives"></i> <br />
          Archives
        </a>
      </li>
    
      
      <li class="menu-item menu-item-tags">
        <a href="/tags">
          <i class="menu-item-icon icon-tags"></i> <br />
          Tags
        </a>
      </li>
    
      
      <li class="menu-item menu-item-about">
        <a href="/about-me">
          <i class="menu-item-icon icon-about"></i> <br />
          About
        </a>
      </li>
    
  </ul>


      </div>
    </div>

    <div id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content">
          

  <div id="posts" class="posts-expand">
    

  <div class="post post-type-normal ">
    <div class="post-header">

      
      
        <h1 class="post-title">
          
          
            
              web_for_pentest writeup
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          Posted on 2015-04-24
        </span>

        
          <span class="post-category">
            &nbsp; | &nbsp; In
            
              <a href="/categories/writeup/">writeup</a>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
            &nbsp; | &nbsp;
            <a href="/2015/04/24/web_for_pentest writeup/#comments" >
              <span class="post-comments-count ds-thread-count" data-thread-key="2015/04/24/web_for_pentest writeup/"></span>
            </a>
          </span>
          
        
      </div>
    </div>

    <div class="post-body">

      
      

      
        <p>A few days ago, I did web for pentest from PentesterLab.Now, this is the writeup form PentesterLab.You also can go <a href="https://pentesterlab.com/exercises/web_for_pentester/course" target="_blank" rel="external">here</a> to read the integral writeup.You also can go to <a href="http://lightless.me/archives/web-for-pentest-writeup.html" target="_blank" rel="external">lightless’s blog</a> , my thoughts are similar with him.<br><a id="more"></a></p>
<h2 id="XSS">XSS</h2><h3 id="Example_1">Example 1</h3><p>The first vulnerable example is just here to get you started with what is going on when you find a XSS. Using the basic payload, you should be able to get an alert box.</p>
<p>Make sure that you check the source code of the HTML page to see that the information you sent as part of the request is echoed back without any HTML encoding.</p>
<h3 id="Example_2">Example 2</h3><p>In the second example, a bit of filtering is involved. The web developer added some regular expressions, to prevent the simple XSS payload from working.</p>
<p>If you play around, you can see that <code>&lt;script&gt;</code> and <code>&lt;/script&gt;</code> are filtered. One of the most basic ways to bypass these types of filters is to play with the case: if you try <code>&lt;sCript&gt;</code> and <code>&lt;/sCRIpt&gt;</code> for example, you should be able to get the alert box.</p>
<h3 id="Example_3">Example 3</h3><p>You notified the developer about your bypass. He has added more filtering, wich now seems to prevent your previous payload. However, he is making a terrible mistake in his code (which was also present in the previous code)…</p>
<p>If you keep playing around, you will realise that if you use Pentest<code>&lt;script&gt;</code>erLab for payload, you can see PentesterLab in the page. You can probably use that to get <code>&lt;script&gt;</code> in the page, and your alert box to pop up.</p>
<h3 id="Example_4">Example 4</h3><p>In this example, the developer decided to completely blacklist the word script: if the request matches script, the execution stops.</p>
<p>Fortunately (or unfortunately depending on what side you are on), there are a lot of ways to get JavaScript to be run (non-exhaustive list):</p>
<blockquote>
<ul>
<li>with the <code>&lt;a</code> tag and for the following events: onmouseover (you will need to pass your mouse over the link), onmouseout, onmousemove, onclick …</li>
<li>with the <code>&lt;a</code> tag directly in the URL: <code>&lt;a href=&#39;javascript:alert(1)&#39;...</code> (you will need to click the link to trigger the JavaScript code and remember that this won’t work since you cannot use script in this example).</li>
<li>with the <code>&lt;img</code> tag directly with the event onerror: <code>&lt;img src=&#39;zzzz&#39; onerror=&#39;alert(1)&#39; /&gt;.</code></li>
<li>with the <code>&lt;div</code> tag and for the following events: onmouseover (you will need to pass your mouse over the link), onmouseout, onmousemove, onclick…</li>
<li>…</li>
</ul>
</blockquote>
<p>You can use any of these techniques to get the alert box to pop-up.</p>
<h3 id="Example_5">Example 5</h3><p>In this example, the <code>&lt;script&gt;</code> tag is accepted and gets echoed back. But as soon as you try to inject a call to alert, the PHP script stops its execution. The problem seems to come from a filter on the word alert.</p>
<p>Using JavaScript’s eval and String.fromCharCode(), you should be able to get an alert box without using the word alert directly. String.fromCharCode() will decode an integer (decimal value) to the corresponding character.</p>
<p>You can write a small tool to transform your payload to this format using your favorite scripting language.</p>
<p>Using this trick and the ascii table, you can easily generate the string: alert(1) and call eval on it.</p>
<p>Another easier bypass is to use the functions prompt or confirm in Javascript. They are less-known, but will give you the same result.</p>
<h3 id="Example_6">Example 6</h3><p>Here, the source code of the HTML page is a bit different. If you read it, you will see that the value you are sending is echoed back inside JavaScript code. To get your alert box, you will not need to inject a script tag, you will just need to correctly complete the pre-existing JavaScript code and add your own payload, then you will need to get rid of the code after your injection point by commenting it out (using //) or by adding some dummy code (var $dummy = “) to close it correctly.</p>
<h3 id="Example_7">Example 7</h3><p>This example is similar to the one before. This time, you won’t be able to use special characters, since they will be HTML-encoded. As you will see, you don’t really need any of these characters.</p>
<p>This issue is common in PHP web applications, because the well-known function used to HTML-encode characters (htmlentities) does not encode single quotes (‘), unless you told it to do so, using the ENT_QUOTES flag.</p>
<h3 id="Example_8">Example 8</h3><p>Here, the value echoed back in the page is correctly encoded. However, there is still a XSS vulnerability in this page. To build the form, the developer used and trusted PHP_SELF which is the path provided by the user. It’s possible to manipulate the path of the application in order to:</p>
<blockquote>
<ul>
<li>call the current page (however you will get an HTTP 404 page);</li>
<li>get a XSS payload in the page.</li>
</ul>
</blockquote>
<p>This can be done because the current configuration of the server will call /xss/example8.php when any URL matching /xss/example8.php/… is accessed. You can simply get your payload inside the page by accessing /xss/example8.php/[XSS_PAYLOAD]. Now that you know where to inject your payload, you will need to adapt it to get it to work and get the famous alert box.</p>
<p>Trusting the path provided by users is a common mistake, and it can often be used to trigger XSS, as well as other issues. This is pretty common in pages with forms, and in error pages (404 and 500 pages).</p>
<h3 id="Example_9">Example 9</h3><p>This example is a DOM-based XSS. This page could actually be completely static and still be vulnerable.</p>
<p>In this example, you will need to read the code of the page to understand what is happening. When the page is rendered, the JavaScript code uses the current URL to retrieve the anchor portion of the URL (#…) and dynamically (on the client side) write it inside the page. This can be used to trigger a XSS vulnerability, if you use the payload as part of the URL.</p>
<h2 id="SQL_injections">SQL injections</h2><p>SQL injections are one of the most common (web) vulnerabilities. All SQL injections exercises, found here, use MySQL for back-end. SQL injections come from a lack of encoding/escaping of user-controlled input when included in SQL queries.</p>
<p>Depending on how the information gets added in the query, you will need different things to break the syntax. There are three different ways to echo information in a SQL statement:</p>
<blockquote>
<ul>
<li>Using quotes: single quote or double quote.</li>
<li>Using back-ticks.</li>
<li>Directly.</li>
</ul>
</blockquote>
<p>For example, if you want to use information as a string you can do:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> name=<span class="string">"root"</span>;</span></span><br></pre></td></tr></table></figure></p>
<p>or<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> name=<span class="string">'root'</span>;</span></span><br></pre></td></tr></table></figure></p>
<p>If you want to use information as an integer you can do:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id=<span class="number">1</span>;</span></span><br></pre></td></tr></table></figure></p>
<p>And finally, if you want to use information as a column name, you will need to do:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> name;</span></span><br></pre></td></tr></table></figure></p>
<p>or<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`name`</span>;</span></span><br></pre></td></tr></table></figure></p>
<p>It’s also possible to use an integer as string, but it will be slower:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="keyword">user</span> <span class="keyword">WHERE</span> id=<span class="string">'1'</span>;</span></span><br></pre></td></tr></table></figure></p>
<p>The way information is echoed back, and even what separator is used, will decide the detection technique to use. However, you don’t have this information, and you will need to try to guess it. You will need to formulate hypotheses and try to verify them. That’s why spending time poking around with the examples on the liveCD is so important.</p>
<h3 id="Example_1-1">Example 1</h3><p>In this first example, we can see that the parameter is a string, and we can see one line in the table. To understand the server side code, we need to start poking around:</p>
<blockquote>
<ul>
<li>If we add extra characters like “1234”, using ?name=root1234, no record is displayed in the table. From here, we can guess that the request uses our value in some kind of matching.</li>
<li>If we inject spaces in the request, using ?name=root+++ (after encoding), the record is displayed. MySQL (by default) will ignore trailing spaces in the string when performing the comparison.</li>
<li>If we inject a double quote, using ?name=root”, no record is displayed in the table.</li>
<li>If we inject a single quote, using ?name=root’, the table disappears. We probably broke something…</li>
</ul>
</blockquote>
<p>From this first part, we can deduce that the request must look like:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> users <span class="keyword">WHERE</span> name=<span class="string">'[INPUT]'</span>;</span></span><br></pre></td></tr></table></figure></p>
<p>Now, let’s verify this hypothesis.</p>
<p>If we are right, the following injections should give the same results.</p>
<blockquote>
<ul>
<li>?name=root’ and ‘1’=’1: the quote in the initial query will close the one at the end of our injection.</li>
<li>?name=root’ and ‘1’=’1’ # (don’t forget to encode #): the quote in the initial query will be commented out.</li>
<li>?name=root’ and 1=1 # (don’t forget to encode #): the quote in the initial query will be commented out and we don’t need the ‘ in ‘1’=’1’.</li>
<li>?name=root’ # (don’t forget to encode #): the quote in the initial query will be commented out and we don’t need the 1=1.</li>
</ul>
</blockquote>
<p>Now these requests may not return the same thing:</p>
<blockquote>
<ul>
<li>?name=root’ and ‘1’=’0: the quote in the initial query will close the one at the end of our injection. The page should not return any result (empty table), since the selection criteria always returns false.</li>
<li>?name=root’ and ‘1’=’1 # (don’t forget to encode #): the quote in the initial query will be commented out. We should have the same result as the query above.</li>
<li>?name=root’ or ‘1’=’1: the quote in the initial query will close the one at the end of our injection. or will select all results, with the second part being always true. It may give the same result, but it’s unlikely, since the value is used as a filter for this example (as opposed to a page only showing one result at a time).</li>
<li>?name=root’ or ‘1’=’1’ # (don’t forget to encode #): the quote in the initial query will be commented out. We should have the same result as the query above.</li>
</ul>
</blockquote>
<p>With all these tests, we can be sure that we have a SQL injection. This training only focuses on detection. You can look into other PentesterLab training, and learn how to exploit this type of issues.</p>
<h3 id="Example_2-1">Example 2</h3><p>In this example, the error message gives away the protection created by the developer: ERROR NO SPACE. This error message appears as soon as a space is injected inside the request. It prevents us from using the ‘ and ‘1’=’1 method, or any fingerprinting that use the space character. However, this filtering is easily bypassed, using tabulation (HT or \t). You will need to use encoding, to use it inside the HTTP request. Using this simple bypass, you should be able to see how to detect this vulnerability.</p>
<h3 id="Example_3-1">Example 3</h3><p>In this example, the developer blocks spaces and tabulations. There is a way to bypass this filter. You can use comments between the keywords to build a valid request without any space or tabulation. The following SQL comments can be used: /**/. By replacing all space/tabulation in the previous examples using this comment, you should be able to test for this vulnerability.</p>
<h3 id="Example_4-1">Example 4</h3><p>This example represents a typical mis-understanding of how to protect against SQL injection. In the 3 previous examples, using the function mysql_real_escape_string would have prevented the vulnerability. In this example, the developer used the same logic. However, the value used is an integer and is not echoed between single quote ‘. Since the value is directly put in the query, using mysql_real_escape_string does not prevent anything. Here, you only need to be able to add spaces and SQL keywords to break the syntax. The detection method is really similar to the one used for string-based SQL injection. You just don’t need the quote at the beginning of the payload.</p>
<p>Another method to detect this is to play with the integer. The initial request is &gt;* ?id=2. By playing with the value 2, we can detect the SQL injection:</p>
<blockquote>
<ul>
<li>?id=2 # (# needs to be encoded) should return the same thing.</li>
<li>?id=3-1 should return the same thing. The database will automatically perform the subtraction and you will get the same result.</li>
<li>?id=2-0 should return the same thing.</li>
<li>?id=1+1 (+ needs to be encoded) should return the same thing. The database will automatically perform the addition and you will get the same result.</li>
<li>?id=2.0 should return the same thing.</li>
</ul>
</blockquote>
<p>And the following should not return the same results:</p>
<blockquote>
<ul>
<li>?id=2+1.</li>
<li>?id=3-0.</li>
</ul>
</blockquote>
<h3 id="Example_5-1">Example 5</h3><p>This example is really similar to the previous, detection-wise. If you look into the code, you will see that the developer tried to prevent SQL injection by using a regular expression:<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!preg_match(<span class="string">'/^[0-9]+/'</span>, <span class="variable">$_GET</span>[<span class="string">"id"</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"ERROR INTEGER REQUIRED"</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>However, the regular expression used is incorrect; it only ensures that the parameter id starts with a digit. The detection method used previously can be used to detect this vulnerability.</p>
<h3 id="Example_6-1">Example 6</h3><p>This example is the other way around. The developer did a mistake in the regular expression again:<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!preg_match(<span class="string">'/[0-9]+$/'</span>, <span class="variable">$_GET</span>[<span class="string">"id"</span>])) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"ERROR INTEGER REQUIRED"</span>);  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>This regular expression only ensures that the parameter id ends with a digit (thanks to the $ sign). It does not ensure that the beginning of the parameter is valid (missing ^). You can use the methods learnt previously. You just need to add an integer at the end of your payload. This digit can be part of the payload or placed after a SQL comment: 1 or 1=1 # 123.</p>
<h3 id="Example_7-1">Example 7</h3><p>Another and last example of bad regular expression:<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!preg_match(<span class="string">'/^-?[0-9]+$/m'</span>, <span class="variable">$_GET</span>[<span class="string">"id"</span>])) &#123;</span><br><span class="line">  <span class="keyword">die</span>(<span class="string">"ERROR INTEGER REQUIRED"</span>);    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Here we can see that the beginning (^) and end ($) of the string are correctly checked. However, the regular expression contains the modifier PCRE_MULTILINE (/m). The multine modifier will only validate that one of the lines is only containing an integer, and the following values will therefore be valid (thanks to the new line in them):</p>
<blockquote>
<ul>
<li>123\nPAYLOAD;</li>
<li>PAYLOAD\n123;</li>
<li>PAYLOAD\n123\nPAYLOAD.</li>
</ul>
</blockquote>
<p>These values need to be encoded when used in a URL, but with the use of encoding and the techniques seen previously you should be able to detect this vulnerability.</p>
<h3 id="Example_8-1">Example 8</h3><p>In this example, the parameter name gives away where it will get echoed in the SQL query. If you look into MySQL documentation, there are two ways to provide a value inside an ORDER BY statement:</p>
<blockquote>
<ul>
<li>directly: ORDER BY name ;</li>
<li>between back-ticks: ORDER BY <code>name</code>.</li>
</ul>
</blockquote>
<p>The ORDER BY statement cannot be used with value inside single quote ‘ or double quote “. If this is used, nothing will get sorted, since MySQL considers these as constants.</p>
<p>To detect this type of vulnerability, we can try to get the same result using different payloads:</p>
<blockquote>
<ul>
<li>name` # (# needs to be encoded) should give the same results.</li>
<li>name` ASC # (# needs to be encoded) should give the same results.</li>
<li>name<code>,</code>name: the back-tick in the initial query will close the one at the end of our injection.</li>
</ul>
</blockquote>
<p>And the following payloads should give different results:</p>
<blockquote>
<ul>
<li>name` DESC # (# needs to be encoded).</li>
<li>name` should not give any result, since the syntax is incorrect.</li>
</ul>
</blockquote>
<h3 id="Example_9-1">Example 9</h3><p>This example is similar to the previous one, but instead of back-tick ``</p>
<p>There are other methods that can be used in this case, since we are directly injecting in the request without a back-tick before. We can use the MySQL IF statement to generate more payloads:</p>
<blockquote>
<ul>
<li>IF(1, name,age) should give the same results.</li>
<li>IF(0, name,age) should give different results. You can see that the columns are sorted by age, but the sort function compares the values as strings, not as integers (10 is smaller than 2). This is a side effect of IF that will sort values as strings if one of the column contains a string.</li>
</ul>
</blockquote>
<h2 id="Directory_traversal">Directory traversal</h2><p>Directory traversals come from a lack of filtering/encoding of information used as part of a path by an application.</p>
<p>As with other vulnerabilities, you can use the “same value technique” to test for this type of issue. For example, if the path used by the application inside a parameter is /images/photo.jpg. You can try to access:</p>
<blockquote>
<ul>
<li>/images/./photo.jpg: you should see the same file.</li>
<li>/images/../photo.jpg: you should get an error.</li>
<li>/images/../images/photo.jpg: you should see the same file again.</li>
<li>/images/../IMAGES/photo.jpg: you should get an error (depending on the file system) or something weird is going on.</li>
</ul>
</blockquote>
<p>If you don’t have the value images and the legitimate path looks like photo.jpg, you will need to work out what the parent repository is.</p>
<p>Once you have tested that, you can try to retrieve other files. On Linux/Unix the most common test cases is the /etc/passwd. You can test: images/../../../../../../../../../../../etc/passwd, if you get the passwd file, the application is vulnerable. The good news is that you don’t need to know the number of ../. If you put too many, it will still work.</p>
<p>Another interesting thing to know is that if you have a directory traversal in Windows, you will be able to access test/../../../file.txt, even if the directory test does not exist. This is not the case, on Linux. This can be really useful where the code concatenates user-controlled data, to create a file name. For example, the following PHP code is supposed to add the parameter id to get a file name (example<em>1.txt for example). On Linux, you won’t be able to exploit this vulnerability if there is no directory starting by example</em>, whereas on Windows, you will be able to exploit it, even if there is no such directory.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$file</span> = <span class="string">"/var/files/example_"</span>.<span class="variable">$_GET</span>[<span class="string">'id'</span>].<span class="string">".txt"</span>;</span><br></pre></td></tr></table></figure></p>
<p>In these exercises, the vulnerabilities are illustrated by a script used inside an &lt;img tag. You will need to read the HTML source (or use “Copy image URL”) to find the correct link, and start exploiting the issue.</p>
<h3 id="Example_1-2">Example 1</h3><p>The first example is a really simple directory traversal. You just need to go up in the file system, and then back down, to get any files you want. In this instance, you will be restricted by the file system permissions, and won’t be able to access /etc/shadow, for example.</p>
<p>In this example, based on the header sent by the server, your browser will display the content of the response. Sometimes the browser will send the response with a header Content-Disposition: attachment, and your browser will not display the file directly. You can open the file to see the content. This method will take you some time for every test.</p>
<p>Using a Linux/Unix system, you can do this more quickly, by using wget:<br><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">% wget -O - <span class="string">'http://vulnerable/dirtrav/example1.php?file=../../../../../../../etc/passwd'</span></span><br><span class="line">[<span class="keyword">...</span>]</span><br><span class="line">daemon:x:<span class="number">1</span>:<span class="number">1</span>:daemon:/usr/sbin:/bin/sh</span><br><span class="line">bin:x:<span class="number">2</span>:<span class="number">2</span>:bin:/bin:/bin/sh</span><br><span class="line">[<span class="keyword">...</span>]</span><br></pre></td></tr></table></figure></p>
<h3 id="Example_2-2">Example 2</h3><p>In this example, you can see that the full path is used to access the file. However, if you try to just replace it with /etc/passwd, you won’t get anything. It looks like a simple check is performed by the PHP code. You can however bypass it by keeping the beginning of the path and add your payload at the end, to go up and back down within the file system.</p>
<h3 id="Example_3-2">Example 3</h3><p>This example is based on a common problem when you exploit directory traversal: the server-side code adds its own suffix to your payload. This can be easily bypassed, by using a NULL BYTE (which you need to URL-encode as %00). Using NULL BYTE to get rid of any suffix added by the server-side code is a common bypass, and works really well in Perl and older versions of PHP.</p>
<p>In this code, the issue is simulated since PHP solved this type of bypass since the version <a href="http://php.net/releases/5_3_4.php" target="_blank" rel="external">5.3.4</a>.</p>
<h2 id="File_include">File include</h2><p>In a lot of applications, developers need to include files to load classes or to share some templates between multiple web pages.</p>
<p>File include vulnerabilities come from a lack of filtering when a user-controlled parameter is used as part of a file name in a call to an including function (require, require_once, include or include_once in PHP for example). If the call to one of these methods is vulnerable, an attacker will be able to manipulate the function to load his own code. File include vulnerabilities can also be used as a directory traversal to read arbitrary files. However, if the arbitrary code contains an opening PHP tag, the file will be interpreted as PHP code.</p>
<p>This including function can allow the loading of local resources or remote resource (a website, for example). If vulnerable, it will lead to:</p>
<blockquote>
<ul>
<li>Local File Include: LFI. A local file is read and interpreted.</li>
<li>Remote File Include: RFI. A remote file is retrieved and interpreted.</li>
</ul>
</blockquote>
<p>By default, PHP disables loading of remote files, thanks to the configuration option: allow_url_include. In the ISO, it has been enabled to allow you to test it.</p>
<h3 id="Example_1-3">Example 1</h3><p>In this first example, you can see an error message, as soon as you inject a special character (a quote, for example) into the parameter:<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Warning: <span class="keyword">include</span>(intro.php'): failed to <span class="keyword">open</span> stream: <span class="keyword">No</span> such <span class="keyword">file</span> or directory <span class="keyword">in</span> /<span class="keyword">var</span>/www/fileincl/example1.php <span class="keyword">on</span> <span class="keyword">line</span> 7 Warning: <span class="keyword">include</span>(): Failed opening 'intro.php'' <span class="keyword">for</span> inclusion (include_path='.:/usr/share/php:/usr/share/pear') <span class="keyword">in</span> /<span class="keyword">var</span>/www/fileincl/example1.php <span class="keyword">on</span> <span class="keyword">line</span> 7</span><br></pre></td></tr></table></figure></p>
<p>If you read the error message carefully, you can extract a lot of information:</p>
<blockquote>
<ul>
<li>The path of the script: /var/www/fileincl/example1.php.</li>
<li>The function used: include().</li>
<li>The value used in the call to include is the value we injected intro.php’ without any addition or filtering.</li>
</ul>
</blockquote>
<p>We can use the methods used to detect directory traversal, to detect file include. For example, you can try to include /etc/passwd by using the ../ technique.</p>
<p>We can test for Remote File Include, by requesting an external resource: <a href="https://pentesterlab.com/" target="_blank" rel="external">https://pentesterlab.com/</a>. We will see that the page from PentesterLab gets included inside the current page.</p>
<p>PentesterLab’s website also contains a test for this type of vulnerability. If you use the URL <a href="https://pentesterlab.com/test_include.txt" target="_blank" rel="external">https://pentesterlab.com/test_include.txt</a>. You should get the result of the function phpinfo() within the current page.</p>
<h3 id="Example_2-3">Example 2</h3><p>In a similar manner to directory traversal, this example adds its own suffix to the value provided. As before, you can get rid of the suffix (for LFI) using a NULL BYTE. For RFI, you can get rid of the suffix, by adding &amp;blah= or ?blah= depending on your URL.</p>
<p>In this exercise, the code simulates the behaviour of older versions of PHP. PHP now correctly handles paths and they cannot be poisoned using a NULL BYTE, as they used to.</p>
<p>In this code, the issue is simulated, since PHP solved this type of bypass since the version (5.3.4)[<a href="http://php.net/releases/5_3_4.php" target="_blank" rel="external">http://php.net/releases/5_3_4.php</a>].</p>
<h2 id="Code_injection">Code injection</h2><p>In this section, we are going to work on code execution. Code executions come from a lack of filtering and/or escaping of user-controlled data. When you are exploiting a code injection, you will need to inject code within the information you are sending to the application. For example, if you want to run the command ls, you will need to send system(“ls”) to the application since it is a PHP application.</p>
<p>Just like other examples of web application issues, it’s always handy to know how to comment out the rest of the code (i.e.: the suffix that the application will add to the user-controlled data). In PHP, you can use // to get rid of the code added by the application.</p>
<p>As with SQL injection, you can use the same value technique to test and ensure you have a code injection:</p>
<blockquote>
<ul>
<li>By using comments and injecting /<em> random value </em>/.</li>
<li>By injecting a simple concatenation “.” (where “ are used to break the syntax and reform it correctly).</li>
<li>By replacing the parameter you provided by a string concatenation, for example “.”ha”.”cker”.” instead of hacker.</li>
</ul>
</blockquote>
<p>You can also use time-based detection for this issue by using the PHP function sleep. You will see a time difference between:</p>
<blockquote>
<ul>
<li>Not using the function sleep or calling it with a delay of zero: sleep(0).</li>
<li>A call to the function with a long delay: sleep(10).</li>
</ul>
</blockquote>
<h3 id="Example_1-4">Example 1</h3><p>This first example is a trivial code injection. If you inject a single quote, nothing happens. However, you can get a better idea of the problem by injecting a double quote:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Parse error: syntax error, unexpected <span class="string">'!'</span>, expecting <span class="string">','</span> or <span class="string">';'</span> <span class="keyword">in</span> /var/www/codeexec/example1.<span class="function"><span class="title">php</span><span class="params">(<span class="number">6</span>)</span></span> : <span class="function"><span class="title">eval</span><span class="params">()</span></span><span class="string">'d code on line 1</span></span><br></pre></td></tr></table></figure></p>
<p>This could be the other way around; the single quote could generate an error where the double quote may not.</p>
<p>Based on the error message, we can see that the code is using the function eval: “Eval is evil…”.</p>
<p>We saw that the double quote breaks the syntax, and that the function eval seems to be using our input. From this, we can try to work out payloads that will give us the same results:</p>
<blockquote>
<ul>
<li>“.”: we are just adding a string concatenation; this should give us the same value.</li>
<li>“./<em>pentesterlab</em>/“: we are just adding a string concatenation and information inside comments; this should give us the same value.</li>
</ul>
</blockquote>
<p>Now that we have similar values working, we need to inject code. To show that we can execute code, we can try to run a command (for example uname -a using the code execution). The full PHP code looks like:<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">system<span class="comment">('uname -a')</span>;</span><br></pre></td></tr></table></figure></p>
<p>The challenge here is to break out of the code syntax and keep a clean syntax. There are many ways to do it:</p>
<blockquote>
<ul>
<li>By adding dummy code: “.system(‘uname -a’); $dummy=”.</li>
<li>By using comment: “.system(‘uname -a’);# or “.system(‘uname -a’);//.</li>
</ul>
</blockquote>
<p>Don’t forget that you will need to URL-encode some of the characters (# and ;) before sending the request.</p>
<h3 id="Example_2-4">Example 2</h3><p>When ordering information, developers use two methods:</p>
<blockquote>
<ul>
<li>order by in a SQL request;</li>
<li>usort in PHP code.</li>
</ul>
</blockquote>
<p>The function usort is often used with the function create_function to dynamically generate the “sorting” function, based on user-controlled information. If the web application lacks potent filtering and validation, this can lead to code execution.</p>
<p>By injecting a single quote, we can get an idea of what is going on:<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Parse</span> <span class="keyword">error</span>: <span class="keyword">syntax</span> <span class="keyword">error</span>, unexpected T_CONSTANT_ENCAPSED_STRING <span class="keyword">in</span> /<span class="keyword">var</span>/www/codeexec/example2.php(22) : runtime-created function <span class="keyword">on</span> <span class="keyword">line</span> 1 Warning: usort() expects parameter 2 to be a valid callback, <span class="keyword">no</span> array or string given <span class="keyword">in</span> /<span class="keyword">var</span>/www/codeexec/example2.php <span class="keyword">on</span> <span class="keyword">line</span> 22</span><br></pre></td></tr></table></figure></p>
<p>The source code of the function looks like the following:<br><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ZEND_FUNCTION(create_function)</span><br><span class="line">&#123;</span><br><span class="line">  [<span class="keyword">...</span>]</span><br><span class="line">    eval_code = (char *) emalloc(eval_code_length);</span><br><span class="line">    sprintf(eval_code, <span class="string">"function "</span> LAMBDA_TEMP_FUNCNAME <span class="string">"(%s)&#123;%s&#125;"</span>, Z_STRVAL_PP(z_function_args), Z_STRVAL_PP(z_function_code));</span><br><span class="line"></span><br><span class="line">    eval_name = zend_make_compiled_string_description(<span class="string">"runtime-created function"</span> TSRMLS_CC);</span><br><span class="line">    retval = zend_eval_string(eval_code, <span class="literal">NULL</span>, eval_name TSRMLS_CC);</span><br><span class="line">  [<span class="keyword">...</span>]</span><br></pre></td></tr></table></figure></p>
<p>We can see that the code that will be evaluated is put inside curly brackets {…}, and we will need this information to correctly finish the syntax, after our injection.</p>
<p>As opposed to the previous code injection, here, you are not injecting inside single or double quotes. We know that we need to close the statement with } and comment out the rest of the code using // or # (with encoding). We can try poking around with:</p>
<blockquote>
<ul>
<li>?order=id;}//: we get an error message (Parse error: syntax error, unexpected ‘;’). We are probably missing one or more brackets.</li>
<li>?order=id);}//: we get a warning. That seems about right.</li>
<li>?order=id));}//: we get an error message (Parse error: syntax error, unexpected ‘)’ i). We probably have too many closing brackets.</li>
</ul>
</blockquote>
<p>Since we now know how to finish the code correctly (a warning does not stop the execution flow), we can inject arbitrary code and gain code execution using ?order=id);}system(‘uname%20-a’);// for example.</p>
<h3 id="Example_3-3">Example 3</h3><p>We talked earlier about regular expression modifiers with multi-line regular expression. Another very dangerous modifier exists in PHP: PCRE_REPLACE_EVAL (/e). This modifier will cause the function preg_replace to evaluate the new value as PHP code, before performing the substitution.</p>
<p><code>PCRE_REPLACE_EVAL</code> has been deprecated as of PHP 5.5.0<br>Here, you will need to change the pattern, by adding the /e modifier. Once you have added this modifier, you should get a notice:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Notice: <span class="operator"><span class="keyword">Use</span> <span class="keyword">of</span> undefined constant hacker - assumed <span class="string">'hacker'</span> <span class="keyword">in</span> /<span class="keyword">var</span>/www/codeexec/example3.php(<span class="number">3</span>) : <span class="keyword">regexp</span> code <span class="keyword">on</span> line <span class="number">1</span></span></span><br></pre></td></tr></table></figure></p>
<p>The function preg_replace tries to evaluate the value hacker as a constant but it’s not defined, and you get this message.</p>
<p>You can easily replace hacker with a call to the function phpinfo() to get a visible result. Once you can see the result of the phpinfo function, you can use the function system to run any command.</p>
<h3 id="Example_4-2">Example 4</h3><p>This example is based on the function assert. When used incorrectly, this function will evaluate the value received. This behaviour can be used to gain code execution.<br>By injecting a single quote or double quote (depending on the way the string was declared), we can see an error message indicating that PHP tried to evaluate the code:<br><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Parse</span> <span class="keyword">error</span>: <span class="keyword">syntax</span> <span class="keyword">error</span>, unexpected T_ENCAPSED_AND_WHITESPACE <span class="keyword">in</span> /<span class="keyword">var</span>/www/codeexec/example4.php(4) : <span class="keyword">assert</span> code <span class="keyword">on</span> <span class="keyword">line</span> 1 Catchable fatal <span class="keyword">error</span>: <span class="keyword">assert</span>(): Failure evaluating code: 'hacker'' <span class="keyword">in</span> /<span class="keyword">var</span>/www/codeexec/example4.php <span class="keyword">on</span> <span class="keyword">line</span> 4</span><br></pre></td></tr></table></figure></p>
<p>Once we broke the syntax, we need to try to reconstruct it correctly. We can try the following: hacker’.’. The error message disappeared.</p>
<p>Now that we know how to finish the syntax to avoid errors, we can just inject our payload to run the function phpinfo(): hacker’.phpinfo().’ and we get the configuration of the PHP engine in the page.</p>
<h2 id="Command_injection">Command injection</h2><p>Command injection comes from a lack of filtering and encoding of information used as part of a command. The simplest example comes from using the function system (to run commands) and take an HTTP parameter as an argument of this command.</p>
<p>There are many ways to exploit a command injection:</p>
<blockquote>
<ul>
<li>By injecting the command inside backticks, for example <code>id</code></li>
<li>By redirecting the result of the first command into the second | id</li>
<li>By running another command if the first one succeeds: &amp;&amp; id (where &amp; needs to be encoded)</li>
<li>By running another command if the first one fails (and making sure it does: error || id (where error is just here to cause an error).<br>It’s also possible to use the same value technique to perform this type of detection. For example, you can replace 123 with <code>echo 123</code>. The command inside backticks will be executed first, and return exactly the same value to be used by the command.</li>
</ul>
</blockquote>
<p>You can also use time-based vectors to detect these kinds of vulnerabilities. You can use a command that will take time to process on the server (with a risk of denial of service). You can also use the command sleep to tell the server to wait a certain amount of time before continuing. For example, using sleep 10.</p>
<h3 id="Example_1-5">Example 1</h3><p>The first example is a trivial command injection. The developer didn’t perform any input validation, and you can directly inject your commands after the ip parameter.</p>
<p>Based on the techniques seen above, you can for example, use the payload &amp;&amp; cat /etc/passwd (with encoding) to see the content of /etc/passwd.</p>
<h3 id="Example_2-5">Example 2</h3><p>This example validates the parameter provided, but does so incorrectly. As we saw before with the SQL injection, the regular expression used is multi-line. Using the same technique we saw for the SQL injection, you can easily gain code execution.</p>
<p>The good thing here is that you don’t even need to inject a separator. You can just add the encoded new line (%0a) and then put your command.</p>
<h3 id="Example_3-4">Example 3</h3><p>This example is really similar to the previous one; the only difference is that the developer does not stop the script correctly. In PHP, an easy and simple way to redirect users if one of the value provided doesn’t match some security constraint is to call the function header. However, even if the browser will get redirected, this function does not stop the execution flow, and the script will still finish to run with the dangerous parameter. The developer needs to call the function die after the call to the function header, to avoid this issue.</p>
<p>You cannot easily exploit this vulnerability in your browser, since your browser will follow the redirect, and will not display the redirecting page. To exploit this issue you can use telnet:<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">% telnet vulnerable <span class="number">80</span> </span><br><span class="line">GET /commandexec/example3.php?ip=<span class="number">127.0</span>.<span class="number">0.1</span><span class="string">|uname+-a HTTP/1.0</span></span><br></pre></td></tr></table></figure></p>
<p>or using netcat:<br><figure class="highlight nimrod"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">% echo <span class="string">"GET /commandexec/example3.php?ip=127.0.0.1|uname+-a HTTP/1.0\r\n"</span> | nc vulnerable <span class="number">80</span></span><br></pre></td></tr></table></figure></p>
<p>If you look carefully at the response, you will see that you get a 302 redirect, but you can see the result of the command uname -a in the body of the response.</p>
<h2 id="LDAP_attacks">LDAP attacks</h2><p>In this section, we will cover LDAP attacks. LDAP is often used as a backend for authentication, especially in Single-Sign-On (SSO) solutions. LDAP has its own syntax that we will see in more detail, in the following examples.</p>
<h3 id="Example_1-6">Example 1</h3><p>In this first example, you connect to a LDAP server, using your username and password. In this instance, The LDAP server does not authenticate you, since your credentials are invalid.</p>
<p>However, some LDAP servers authorise NULL Bind: if null values are sent, the LDAP server will proceed to bind the connection, and the PHP code will think that the credentials are correct. To get the bind with 2 null values, you will need to completely remove this parameter from the query. If you keep something like username=&amp;password= in the URL, these values will not work, since they won’t be null; instead, they will be empty.</p>
<p>This is an important check to perform on all login forms that you will test in the future, even if the backend is not LDAP-based.</p>
<h3 id="Example_2-6">Example 2</h3><p>The most common pattern of LDAP injection is to be able to inject in a filter. Here, we will see how you can use LDAP injection to bypass an authentication check.</p>
<p>First, you need to learn a bit of LDAP syntax. When you are retrieving a user, based on its username, the following will be used:<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="list">(<span class="keyword">cn=</span><span class="collection">[INPUT]</span>)</span></span><br></pre></td></tr></table></figure></p>
<p>If you want to add more conditions and some boolean logic, you can use:<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">A <span class="built_in">boolean</span> <span class="keyword">OR</span> <span class="keyword">using</span> |: (|(cn=[INPUT1])(cn=[INPUT2])) <span class="keyword">to</span> <span class="keyword">get</span> records matching [INPUT1] <span class="keyword">or</span> [INPUT2].</span><br><span class="line">A <span class="built_in">boolean</span> <span class="keyword">AND</span> <span class="keyword">using</span> &amp;: (&amp;(cn=[INPUT1])(userPassword=[INPUT2])) <span class="keyword">to</span> <span class="keyword">get</span> records <span class="keyword">for</span> which the cn matches [INPUT1] <span class="keyword">and</span> the password matches [INPUT2].</span><br></pre></td></tr></table></figure></p>
<p>As you can see, the boolean logic is located at the beginning of the filter. Since you’re likely to inject after it, it’s not always possible (depending on the LDAP server) to inject logic inside the filter, if it’s just (cn=[INPUT]).</p>
<p>LDAP uses the wildcard <em> character very often, to match any values. This can be used for match everything </em> or just substrings (for example, adm* for all words starting with adm).</p>
<p>As with other injections, we will need to remove anything added by the server-side code. We can get rid of the end of the filter, using a NULL BYTE (encoded as %00).</p>
<p>Here, we have a login script. We can see that if we use:</p>
<blockquote>
<ul>
<li>username=hacker&amp;password=hacker we get authenticated (this is the normal request).</li>
<li>username=hack*&amp;password=hacker we get authenticated (the wildcard matches the same value).</li>
<li>username=hacker&amp;password=hac* we don’t get authenticated (the password may likely be hashed).</li>
</ul>
</blockquote>
<p>Now, we will see how we can use the LDAP injection, in the username parameter to bypass the authentication. Based on our previous tests, we can deduce that the filter probably looks like:<br><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="list">(<span class="keyword">&amp;</span><span class="list">(<span class="keyword">cn=</span><span class="collection">[INPUT1]</span>)</span><span class="list">(<span class="keyword">userPassword=HASH</span><span class="collection">[INPUT2]</span>)</span>)</span></span><br></pre></td></tr></table></figure></p>
<p>Where HASH is an unsalted hash (probably MD5 or SHA1).</p>
<p>LDAP supports several formats: <code>{CLEARTEXT}</code>, <code>{MD5}</code>, <code>{SMD5}</code> (salted MD5), <code>{SHA}</code>, <code>{SSHA}</code> (salted SHA1), <code>{CRYPT}</code> for storing passwords’.<br>Since [INPUT2] is hashed, we cannot use it to inject our payload.</p>
<p>Our goal here will be to inject inside [INPUT1] (the username parameter). We will need to inject:</p>
<blockquote>
<ul>
<li>The end of the current filter using hacker).</li>
<li>An always-true condition ((cn=*) for example)</li>
<li>A ) to keep a valid syntax and close the first ).</li>
<li>A NULL BYTE (%00) to get rid of the end of the filter.</li>
</ul>
</blockquote>
<p>Once you put this together, you should be able to login as hacker with any password. You can then try to find other users using the wildcard trick. For example, you can use a* in the first part of the filter, and check who you are logged in as.</p>
<p>In most cases, LDAP injection will allow only you to bypass authentication and authorisation checks. Retrieving arbitrary data (as opposed to just getting more results) is often really challenging or impossible.</p>
<h2 id="Upload">Upload</h2><p>In this section, we will cover how to use file upload functionalities to gain code execution.</p>
<p>In web applications (especially the ones using the file systems to determine what code should be run), you can get code execution on a server, if you manage to upload a file with the right filename (often depending on the extension). In this section, we will see the basics of these types of attacks.</p>
<p>First, since we are working on a PHP application, we will need a PHP web shell. A web shell is just a simple script or web application that runs the code or commands provided. For example, in PHP, the following code is a really simple web shell:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="preprocessor">&lt;?php</span></span><br><span class="line">  system(<span class="variable">$_GET</span>[<span class="string">"cmd"</span>]);</span><br><span class="line"><span class="preprocessor">?&gt;</span></span></span><br></pre></td></tr></table></figure></p>
<p>More complex web shells can perform advanced operations, such as providing database and file system access, or even TCP tunnelling.</p>
<h3 id="Example_1-7">Example 1</h3><p>The first example is a really basic upload form, with no restriction. By using the web shell above, and naming it with a .php extension you should be able to get it upload onto the server. Once it’s uploaded, you can access the script (with the parameter cmd=uname for example) to get command execution.</p>
<h3 id="Example_2-7">Example 2</h3><p>In this second example, the developer put a restriction on the file name. The file name cannot end with .php. To bypass this restriction, you can use one of the following methods:</p>
<blockquote>
<ul>
<li>change the extension to .php3. On other systems, extensions like .php4 or .php5 may also work. It depends on the configuration of the web server.</li>
<li>use an extension that Apache does not know .blah after the extension .php. Since Apache does not know how to handle the extension .blah, it will move to the next one: .php and run the PHP code.</li>
<li>upload a .htaccess file, enabling another extension to be ran by PHP (You can learn more about this technique in PentesterLab’s training: From <a href="https://pentesterlab.com/fromsqlitoshellpg_edition.html" target="_blank" rel="external">SQL Injection to Shell: PostgreSQL edition</a></li>
</ul>
</blockquote>
<p>Using one of these methods, you should be able to gain command execution.</p>
<h2 id="XML_related_attacks">XML related attacks</h2><p>In this section, XML related attacks will be detailed. These types of attacks are common with web services and with applications using XPath to retrieve a configuration setting from a XML file (for example, to know what backend they need to use to authenticate a user, based on the organisation’s name provided).</p>
<h3 id="Example_1-8">Example 1</h3><p>Some XML parsers will resolve external entities, and will allow a user controlling the XML message to access resources; for example to read a file on the system. The following entity can be declared, for example:<br><figure class="highlight erlang-repl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="exclamation_mark">!</span><span class="variable">ENTITY</span> <span class="function_or_atom">x</span> <span class="variable">SYSTEM</span> <span class="string">"file:///etc/passwd"</span>&gt;</span><br></pre></td></tr></table></figure></p>
<p>You will need to envelope this properly, in order to get it to work correctly:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="doctype">&lt;!DOCTYPE test [</span><br><span class="line">    &lt;!ENTITY x SYSTEM "file:///etc/passwd"&gt;]&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>You can then simply use the reference to x: &x; (don’t forget to encode &amp;) to get the corresponding result inserted in the XML document during its parsing (server side).</p>
<p>In this example, the exploitation occurs directly inside a GET request, but it’s more likely that these types of requests are performed using a POST request, in a traditional web application. This issue is also really common with web services, and is probably the first test you want to do, when attacking an application that accepts XML messages.</p>
<p>This example can also be used to get the application to perform HTTP requests (by using http:// instead of file://) and can be used as a port scanner. However, the content retrieved is often incomplete since, the XML parser will try to parse it as part of the document.</p>
<p>You can also use <code>ftp://</code> and <code>https://</code></p>
<h3 id="Example_2-8">Example 2</h3><p>In this example, the code uses the user’s input, inside an XPath expression. XPath is a query language, which selects nodes from an XML document. Imagine the XML document as a database, and XPath as an SQL query. If you can manipulate the query, you will be able to retrieve elements to which you normally should not have access.</p>
<p>If we inject a single quote, we can see the following error:<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Warning: SimpleXMLElement::<span class="function"><span class="title">XPath</span><span class="params">()</span></span>: Invalid predicate <span class="keyword">in</span> /var/www/xml/example2<span class="class">.php</span> on line <span class="number">7</span> Warning: SimpleXMLElement::<span class="function"><span class="title">XPath</span><span class="params">()</span></span>: xmlXPathEval: evaluation failed <span class="keyword">in</span> /var/www/xml/example2<span class="class">.php</span> on line <span class="number">7</span> Warning: Variable passed to <span class="function"><span class="title">each</span><span class="params">()</span></span> is not an array or <span class="tag">object</span> <span class="keyword">in</span> /var/www/xml/example2<span class="class">.php</span> on line <span class="number">8</span></span><br></pre></td></tr></table></figure></p>
<p>Just like SQL injection, XPath allows you to do boolean logic, and you can try:</p>
<blockquote>
<ul>
<li>‘ and ‘1’=’1 and you should get the same result.</li>
<li>‘ or ‘1’=’0 and you should get the same result.</li>
<li>‘ and ‘1’=’0 and you should not get any result.</li>
<li>‘ or ‘1’=’1 and you should get all results.</li>
</ul>
</blockquote>
<p>Based on these tests and previous knowledge of XPath, it’s possible to get an idea of what the XPath expression looks like:<br><figure class="highlight scheme"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="list">[<span class="keyword">PARENT</span> NODES]/name<span class="list">[<span class="keyword">.=</span>'<span class="list">[<span class="keyword">INPUT</span>]']/<span class="list">[<span class="keyword">CHILD</span> NODES]</span></span></span></span></span><br></pre></td></tr></table></figure></p>
<p>To comment out the rest of the XPath expression, you can use a NULL BYTE (which you will need to encode as %00). As we can see in the XPath expression above, we also need to add a ] to properly complete the syntax. Our payload now looks like hacker’]%00 (or hacker’ or 1=1]%00 if we want all results).</p>
<p>If we try to find the child of the current node, using the payload<br><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">'%20or%201=1]/child::node()%00, we don'</span>t <span class="keyword">get</span> much information.</span><br></pre></td></tr></table></figure></p>
<p>Here, the problem is that we need to got back up in the node hierarchy, to get more information. In XPath, this can be done using parent::* as part of the payload. We can now select the parent of the current node, and display all the child node using<br><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">hacker</span>'<span class="number">%20</span>or<span class="number">%201</span>=1]/parent::*/child::node()<span class="number">%00</span>.</span><br></pre></td></tr></table></figure></p>
<p>One of the node’s value looks like a password. We can confirm this, by checking if the node’s name is password using the payload<br><figure class="highlight matlab"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hacker<span class="operator">'</span>]/parent::*/password<span class="comment">%00.</span></span><br></pre></td></tr></table></figure></p>

      
    </div>

    <div class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Code-Injection/"> #Code_Injection </a>
          
            <a href="/tags/Command-Injection/"> #Command_Injection </a>
          
            <a href="/tags/Directory-traversal/"> #Directory_traversal </a>
          
            <a href="/tags/File-Upload/"> #File_Upload </a>
          
            <a href="/tags/LDAP-Attacks/"> #LDAP_Attacks </a>
          
            <a href="/tags/PentesterLab/"> #PentesterLab </a>
          
            <a href="/tags/XML-Attacks/"> #XML_Attacks </a>
          
            <a href="/tags/XSS/"> #XSS </a>
          
            <a href="/tags/sql-injection/"> #sql_injection </a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/04/30/pip安装库时遇到的问题/">pip安装库时遇到的问题</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/04/24/BCTF-warmup-writeup/">BCTF-warmup-writeup</a>
            
          </div>
        </div>
      

      
      
    </div>
  </div>



    
      <div class="comments" id="comments">
        
          <div class="ds-thread" data-thread-key="2015/04/24/web_for_pentest writeup/"
               data-title="web_for_pentest writeup" data-url="http://edward-l.github.io/2015/04/24/web_for_pentest writeup/">
          </div>
        
      </div>
    
  </div>


        </div>

        
      </div>


      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <div id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table Of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Overview
          </li>
        </ul>
      

      <div class="site-overview">
        <div class="site-author motion-element">
          <img class="site-author-image" src="http://edwardl.qiniudn.com/psb.jpeg" alt="Edward_L" />
          <p class="site-author-name">Edward_L</p>
        </div>
        <p class="site-description motion-element"></p>
        <div class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">48</span>
              <span class="site-state-item-name">posts</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">10</span>
              <span class="site-state-item-name">categories</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">57</span>
              <span class="site-state-item-name">tags</span>
              </a>
          </div>

        </div>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml">
              <i class="menu-item-icon icon-feed"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
              <a href="https://github.com/Edward-L" target="_blank">GitHub</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://weibo.com/Edward7L" target="_blank">Weibo</a>
            </span>
            
              <span class="links-of-author-item">
              <a href="http://www.zhihu.com/people/lin-zhe-xi" target="_blank">ZhiHu</a>
            </span>
            
          
        </div>

        
        


    <!--增加swiftype搜索功能-->
    <form class="menu-item menu-item-search">
      <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
    </form>
    
    <script type="text/javascript">
      (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
      (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
      e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
      })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

      _st('install','HxJvJ6xstU7NZbDoyPPn','2.0.0');
    </script>
    <!--增加swiftype搜索功能end-->           	   
    
	</div>      

        <div class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#XSS"><span class="nav-number">1.</span> <span class="nav-text">XSS</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_1"><span class="nav-number">1.1.</span> <span class="nav-text">Example 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_2"><span class="nav-number">1.2.</span> <span class="nav-text">Example 2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_3"><span class="nav-number">1.3.</span> <span class="nav-text">Example 3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_4"><span class="nav-number">1.4.</span> <span class="nav-text">Example 4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_5"><span class="nav-number">1.5.</span> <span class="nav-text">Example 5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_6"><span class="nav-number">1.6.</span> <span class="nav-text">Example 6</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_7"><span class="nav-number">1.7.</span> <span class="nav-text">Example 7</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_8"><span class="nav-number">1.8.</span> <span class="nav-text">Example 8</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_9"><span class="nav-number">1.9.</span> <span class="nav-text">Example 9</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SQL_injections"><span class="nav-number">2.</span> <span class="nav-text">SQL injections</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_1-1"><span class="nav-number">2.1.</span> <span class="nav-text">Example 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_2-1"><span class="nav-number">2.2.</span> <span class="nav-text">Example 2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_3-1"><span class="nav-number">2.3.</span> <span class="nav-text">Example 3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_4-1"><span class="nav-number">2.4.</span> <span class="nav-text">Example 4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_5-1"><span class="nav-number">2.5.</span> <span class="nav-text">Example 5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_6-1"><span class="nav-number">2.6.</span> <span class="nav-text">Example 6</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_7-1"><span class="nav-number">2.7.</span> <span class="nav-text">Example 7</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_8-1"><span class="nav-number">2.8.</span> <span class="nav-text">Example 8</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_9-1"><span class="nav-number">2.9.</span> <span class="nav-text">Example 9</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Directory_traversal"><span class="nav-number">3.</span> <span class="nav-text">Directory traversal</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_1-2"><span class="nav-number">3.1.</span> <span class="nav-text">Example 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_2-2"><span class="nav-number">3.2.</span> <span class="nav-text">Example 2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_3-2"><span class="nav-number">3.3.</span> <span class="nav-text">Example 3</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#File_include"><span class="nav-number">4.</span> <span class="nav-text">File include</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_1-3"><span class="nav-number">4.1.</span> <span class="nav-text">Example 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_2-3"><span class="nav-number">4.2.</span> <span class="nav-text">Example 2</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Code_injection"><span class="nav-number">5.</span> <span class="nav-text">Code injection</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_1-4"><span class="nav-number">5.1.</span> <span class="nav-text">Example 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_2-4"><span class="nav-number">5.2.</span> <span class="nav-text">Example 2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_3-3"><span class="nav-number">5.3.</span> <span class="nav-text">Example 3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_4-2"><span class="nav-number">5.4.</span> <span class="nav-text">Example 4</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Command_injection"><span class="nav-number">6.</span> <span class="nav-text">Command injection</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_1-5"><span class="nav-number">6.1.</span> <span class="nav-text">Example 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_2-5"><span class="nav-number">6.2.</span> <span class="nav-text">Example 2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_3-4"><span class="nav-number">6.3.</span> <span class="nav-text">Example 3</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#LDAP_attacks"><span class="nav-number">7.</span> <span class="nav-text">LDAP attacks</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_1-6"><span class="nav-number">7.1.</span> <span class="nav-text">Example 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_2-6"><span class="nav-number">7.2.</span> <span class="nav-text">Example 2</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Upload"><span class="nav-number">8.</span> <span class="nav-text">Upload</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_1-7"><span class="nav-number">8.1.</span> <span class="nav-text">Example 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_2-7"><span class="nav-number">8.2.</span> <span class="nav-text">Example 2</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#XML_related_attacks"><span class="nav-number">9.</span> <span class="nav-text">XML related attacks</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_1-8"><span class="nav-number">9.1.</span> <span class="nav-text">Example 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Example_2-8"><span class="nav-number">9.2.</span> <span class="nav-text">Example 2</span></a></li></ol></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </div>
      

    </div>
  </div>


    </div>

    <div id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; &nbsp;  2014 - 
  2015
  <span class="with-love">
    <i class="icon-heart"></i>
  </span>
  <span class="author">Edward_L</span>
</div>

<div class="powered-by">
  Powered by <a class="theme-link" href="http://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </div>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  

  

  <script type="text/javascript">
  function hasMobileUA () {
    var nav = window.navigator;
    var ua = nav.userAgent;
    var pa = /iPad|iPhone|Android|Opera Mini|BlackBerry|webOS|UCWEB|Blazer|PSP|IEMobile|Symbian/g;

    return pa.test(ua);
  }

  function isDesktop () {
    return screen.width > 991 && !hasMobileUA();
  }

  function isTablet () {
    return screen.width < 992 && screen.width > 767 && hasMobileUA();
  }

  function isMobile () {
    return screen.width < 767 && hasMobileUA();
  }

  function escapeSelector (selector) {
    return selector.replace(/[!"$%&'()*+,.\/:;<=>?@[\\\]^`{|}~]/g, "\\$&")
  }

  function displaySidebar () {
    setTimeout(function () {
      $('.sidebar-toggle').trigger('click');
    }, 800);
  }
</script>

  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" id="motion.global">
  $(document).ready(function () {
    var body = $('body');
    var isSidebarVisible = false;
    var sidebarToggle = $('.sidebar-toggle');
    var sidebarToggleLine1st = $('.sidebar-toggle-line-first')
    var sidebarToggleLine2nd = $('.sidebar-toggle-line-middle');
    var sidebarToggleLine3rd = $('.sidebar-toggle-line-last');
    var sidebar = $('.sidebar');

    var SIDEBAR_WIDTH = '320px';
    var SIDEBAR_DISPLAY_DURATION = 300;

    var sidebarToogleLineStatusInit = {width: '100%', opacity: 1, left: 0, rotateZ: 0, top: 0};

    var sidebarToggleLine1stStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine1stStatusArrow = {width: '50%', rotateZ: '-45deg', top: '2px'};
    var sidebarToogleLine1stStatusClose = {width: '100%', rotateZ: '-45deg', top: '5px'};

    var sidebarToggleLine2ndStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine2ndStatusArrow = {width: '90%'};
    var sidebarToogleLine2ndStatusClose = {opacity: 0};

    var sidebarToggleLine3rdStatusInit = sidebarToogleLineStatusInit;
    var sidebarToggleLine3rdStatusArrow = {width: '50%', rotateZ: '45deg', top: '-2px'};
    var sidebarToogleLine3rdStatusClose = {width: '100%', rotateZ: '45deg', top: '-5px'};

    LogoAndMenuMotion();
    sidebarToggleMotion();
    postsListMotion();
    backToTopMotion();


    $(document)
      .on('sidebar.isShowing', function () {
        isDesktop() && body.velocity(
          {paddingRight: SIDEBAR_WIDTH},
          SIDEBAR_DISPLAY_DURATION
        );
        sidebarContentMotion();
      })
      .on('sidebar.isHiding', function () {});

    function LogoAndMenuMotion() {
      $.Velocity.RunSequence([
        { e: $('.brand'), p: { opacity: 1 }, o: { duration: 100 } },
        { e: $('.logo'), p: { opacity: 1, top: 0 }, o: { duration: 50} },
        
        { e: $('.logo-line-before i'), p: { translateX: "100%" }, o: { duration: 500, sequenceQueue: false } },
        { e: $('.logo-line-after i'), p: { translateX: "-100%" }, o: { duration: 500, sequenceQueue: false } },
        
        { e: $('.site-title'), p: { opacity: 1, top: 0 }, o: { duration: 200 } }
      ]);
      $('.menu-item').velocity('transition.slideDownIn', {display: null});
    }


    function backToTopMotion () {
      var b2top = $('.back-to-top');
      b2top.on('click', function () {
        body.velocity('scroll');
      });
    }

    function sidebarShowMotion () {

      sidebarToggleLine1st.velocity(sidebarToogleLine1stStatusClose);
      sidebarToggleLine2nd.velocity(sidebarToogleLine2ndStatusClose);
      sidebarToggleLine3rd.velocity(sidebarToogleLine3rdStatusClose);

      sidebar.velocity({width: SIDEBAR_WIDTH}, {
        display: 'block',
        duration: SIDEBAR_DISPLAY_DURATION,
        complete: function () {
          sidebar.addClass('sidebar-active');
          sidebar.trigger('sidebar.didShow');
        }
      });
      sidebar.trigger('sidebar.isShowing');
    }

    function sidebarHideMotion () {
      isDesktop() && body.velocity({paddingRight: 0});
      sidebar.velocity('reverse');

      sidebarToggleLine1st.velocity(sidebarToggleLine1stStatusInit);
      sidebarToggleLine2nd.velocity(sidebarToggleLine2ndStatusInit);
      sidebarToggleLine3rd.velocity(sidebarToggleLine3rdStatusInit);

      sidebar.removeClass('sidebar-active');
      sidebar.trigger('sidebar.isHiding');
    };

    function sidebarContentMotion () {
      $('.sidebar .motion-element').velocity(
        'transition.slideRightIn',
        {stagger: 50, drag: true}
      );
    }

    function postsListMotion () {
      var postMotionOptions = window.postMotionOptions || {stagger: 300, drag: true};
      $('.post').velocity('transition.slideDownIn', postMotionOptions);
    }

    function sidebarToggleMotion () {
      sidebarToggle.on('click', function () {
        isSidebarVisible ? sidebarHideMotion() : sidebarShowMotion();
        isSidebarVisible = !isSidebarVisible;
      });

      sidebarToggle.hover(function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusArrow);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusArrow);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusArrow);
      }, function () {
        if (isSidebarVisible) {return}
        sidebarToggleLine1st.velocity('stop').velocity(sidebarToggleLine1stStatusInit);
        sidebarToggleLine2nd.velocity('stop').velocity(sidebarToggleLine2ndStatusInit);
        sidebarToggleLine3rd.velocity('stop').velocity(sidebarToggleLine3rdStatusInit);
      });
    }
  });

</script>





  
  
<script type="text/javascript" id="bootstrap.scrollspy.custom">
  /* ========================================================================
  * Bootstrap: scrollspy.js v3.3.2
  * http://getbootstrap.com/javascript/#scrollspy
  * ========================================================================
  * Copyright 2011-2015 Twitter, Inc.
  * Licensed under MIT (https://github.com/twbs/bootstrap/blob/master/LICENSE)
  * ======================================================================== */

  /**
   * Custom by iissnan
   *
   * - Add a `clear.bs.scrollspy` event.
   * - Esacpe targets selector.
   */


  +function ($) {
    'use strict';

    // SCROLLSPY CLASS DEFINITION
    // ==========================

    function ScrollSpy(element, options) {
      this.$body          = $(document.body)
      this.$scrollElement = $(element).is(document.body) ? $(window) : $(element)
      this.options        = $.extend({}, ScrollSpy.DEFAULTS, options)
      this.selector       = (this.options.target || '') + ' .nav li > a'
      this.offsets        = []
      this.targets        = []
      this.activeTarget   = null
      this.scrollHeight   = 0

      this.$scrollElement.on('scroll.bs.scrollspy', $.proxy(this.process, this))
      this.refresh()
      this.process()
    }

    ScrollSpy.VERSION  = '3.3.2'

    ScrollSpy.DEFAULTS = {
      offset: 10
    }

    ScrollSpy.prototype.getScrollHeight = function () {
      return this.$scrollElement[0].scrollHeight || Math.max(this.$body[0].scrollHeight, document.documentElement.scrollHeight)
    }

    ScrollSpy.prototype.refresh = function () {
      var that          = this
      var offsetMethod  = 'offset'
      var offsetBase    = 0

      this.offsets      = []
      this.targets      = []
      this.scrollHeight = this.getScrollHeight()

      if (!$.isWindow(this.$scrollElement[0])) {
        offsetMethod = 'position'
        offsetBase   = this.$scrollElement.scrollTop()
      }

      this.$body
        .find(this.selector)
        .map(function () {
          var $el   = $(this)
          var href  = $el.data('target') || $el.attr('href')
          var $href = /^#./.test(href) && $(escapeSelector(href)) // Need to escape selector.

          return ($href
            && $href.length
            && $href.is(':visible')
            && [[$href[offsetMethod]().top + offsetBase, href]]) || null
        })
        .sort(function (a, b) { return a[0] - b[0] })
        .each(function () {
          that.offsets.push(this[0])
          that.targets.push(this[1])
        })


    }

    ScrollSpy.prototype.process = function () {
      var scrollTop    = this.$scrollElement.scrollTop() + this.options.offset
      var scrollHeight = this.getScrollHeight()
      var maxScroll    = this.options.offset + scrollHeight - this.$scrollElement.height()
      var offsets      = this.offsets
      var targets      = this.targets
      var activeTarget = this.activeTarget
      var i

      if (this.scrollHeight != scrollHeight) {
        this.refresh()
      }

      if (scrollTop >= maxScroll) {
        return activeTarget != (i = targets[targets.length - 1]) && this.activate(i)
      }

      if (activeTarget && scrollTop < offsets[0]) {
        $(this.selector).trigger('clear.bs.scrollspy')  // Add a custom event.
        this.activeTarget = null
        return this.clear()
      }

      for (i = offsets.length; i--;) {
        activeTarget != targets[i]
          && scrollTop >= offsets[i]
          && (!offsets[i + 1] || scrollTop <= offsets[i + 1])
          && this.activate(targets[i])
      }
    }

    ScrollSpy.prototype.activate = function (target) {
      this.activeTarget = target

      this.clear()

      var selector = this.selector +
        '[data-target="' + target + '"],' +
        this.selector + '[href="' + target + '"]'

      var active = $(selector)
        .parents('li')
        .addClass('active')

      if (active.parent('.dropdown-menu').length) {
        active = active
          .closest('li.dropdown')
          .addClass('active')
      }

      active.trigger('activate.bs.scrollspy')
    }

    ScrollSpy.prototype.clear = function () {
      $(this.selector)
        .parentsUntil(this.options.target, '.active')
        .removeClass('active')
    }


    // SCROLLSPY PLUGIN DEFINITION
    // ===========================

    function Plugin(option) {
      return this.each(function () {
        var $this   = $(this)
        var data    = $this.data('bs.scrollspy')
        var options = typeof option == 'object' && option

        if (!data) $this.data('bs.scrollspy', (data = new ScrollSpy(this, options)))
        if (typeof option == 'string') data[option]()
      })
    }

    var old = $.fn.scrollspy

    $.fn.scrollspy             = Plugin
    $.fn.scrollspy.Constructor = ScrollSpy


    // SCROLLSPY NO CONFLICT
    // =====================

    $.fn.scrollspy.noConflict = function () {
      $.fn.scrollspy = old
      return this
    }


    // SCROLLSPY DATA-API
    // ==================

    $(window).on('load.bs.scrollspy.data-api', function () {
      $('[data-spy="scroll"]').each(function () {
        var $spy = $(this)
        Plugin.call($spy, $spy.data())
      })
    })

  }(jQuery);
</script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var $sidebarInner = $('.sidebar-inner');
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.didShow', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;
          var self = this;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      $(indicator).velocity('stop').velocity({
        opacity: action === 'show' ? 0.4 : 0
      }, { duration: 100 });
    }

  });
</script>


  <script type="text/javascript" id="sidebar.nav">
    $(document).ready(function () {
      var html = $('html');

      $('.sidebar-nav li').on('click', function () {
        var item = $(this);
        var activeTabClassName = 'sidebar-nav-active';
        var activePanelClassName = 'sidebar-panel-active';
        if (item.hasClass(activeTabClassName)) {
          return;
        }

        var currentTarget = $('.' + activePanelClassName);
        var target = $('.' + item.data('target'));

        currentTarget.velocity('transition.slideUpOut', 200, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', 200)
            .addClass(activePanelClassName);
        });

        item.siblings().removeClass(activeTabClassName);
        item.addClass(activeTabClassName);
      });

      $('.post-toc a').on('click', function (e) {
        e.preventDefault();
        var offset = $(escapeSelector(this.getAttribute('href'))).offset().top;
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        });
      });

      // Expand sidebar on post detail page by default, when post has a toc.
      if (isDesktop() && HEXO_SIDEBAR_CONFIGURATION === 'post') {
        displaySidebar();
      }
    });
  </script>




  <script type="text/javascript">
    var HEXO_SIDEBAR_CONFIGURATION = 'hide';
    $(document).ready(function () {
      if (HEXO_SIDEBAR_CONFIGURATION === 'always') {
        displaySidebar();
      }
    });
  </script>

  

  
  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"edward7l"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  


  
  
  <script type="text/javascript">
    (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
        function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
      e=o.createElement(i);r=o.getElementsByTagName(i)[0];
      e.src='//www.google-analytics.com/analytics.js';
      r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
    ga('create','UA-56285224-2');ga('send','pageview');
  </script>

</body>
</html>
